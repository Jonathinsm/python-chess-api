<!DOCTYPE html>
<html>

<head>
    <title>Chess App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <meta charset="UTF-8">
    <style>
        .chess-board {
            border-spacing: 0;
            border-collapse: collapse;
        }

        .chess-board th {
            padding: .5em;
        }

        .chess-board td {
            border: 0px solid;
            width: 4em;
            height: 4em;
        }

        .chess-board .light {
            background: #A3A3A3;
        }

        .chess-board .dark {
            background: #888888;
        }

        .container {
            margin-left: 20px;
        }

        #sidebaritem {
            border-style: inset;
        }

        #allgames {
            max-width: 600px;
        }

        .main {
            margin-left: 250px;
            padding: 0px 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2">
                <div class="" id="">
                    <div class="row" id="sidebaritem">
                        <div class="col">
                            <form>
                                <h4>New Game</h4>
                                <div class="form-group">
                                    <div class="col">
                                        <input id="p1" type="text" class="form-control" placeholder="White pieces">
                                    </div>
                                    <div class="col">
                                        <input id="p2" type="text" class="form-control" placeholder="Black pieces">
                                    </div>
                                </div>
                                <button id="btnstart" type="submit" class="btn btn-primary">New Game</button>
                            </form>
                        </div>
                    </div>
                    <br>
                    <div class="row" id="sidebaritem">
                        <div class="col">
                            <form>
                                <h4>Make a Move</h4>
                                <div class="form-group">
                                    <label for="exampleFormControlSelect1">Select Player</label>
                                    <select class="form-control" id="whoplay">
                                        <option id="op1">1</option>
                                        <option id="op2">2</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <div class="col">
                                        <input id="initpos" type="text" class="form-control"
                                            placeholder="Initial position">
                                    </div>
                                    <div class="col">
                                        <input id="endpos" type="text" class="form-control" placeholder="End position">
                                    </div>
                                </div>
                                <button id="btnplay" type="submit" class="btn btn-secondary">Move</button>
                            </form>
                        </div>
                    </div>
                    <br>
                    <div class="row" id="sidebaritem">
                        <div class="col">
                            <form>
                                <h4>Delete current Game</h4>
                                <button id="btnreset" type="submit" class="btn btn-dark">Delete</button>
                            </form>
                        </div>
                    </div>
                    <br>
                    <div class="row" id="sidebaritem">
                        <div class="col">
                            <form>
                                <h4>Delete all Games</h4>
                                <button id="btnClean" type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-5-sm">
                <div class="card">
                    <div class="card-header">
                        <table>
                            <tbody>
                                <tr>
                                    <th id="rp1"></th>
                                </tr>
                                <tr>
                                    <th id="rp2"></th>
                                </tr>
                                <tr>
                                    <th id="nextp"></th>
                                </tr>
                                <th id="game"></th>
                            </tbody>
                        </table>
                    </div>
                    <div class="card-body">
                        <table class="chess-board">
                            <tbody>
                                <tr>
                                    <th>8</th>
                                    <td id="a8" class="light"></td>
                                    <td id="b8" class="dark"></td>
                                    <td id="c8" class="light"></td>
                                    <td id="d8" class="dark"></td>
                                    <td id="e8" class="light"></td>
                                    <td id="f8" class="dark"></td>
                                    <td id="g8" class="light"></td>
                                    <td id="h8" class="dark"></td>
                                </tr>
                                <tr>
                                    <th>7</th>
                                    <td id="a7" class="dark"></td>
                                    <td id="b7" class="light"></td>
                                    <td id="c7" class="dark"></td>
                                    <td id="d7" class="light"></td>
                                    <td id="e7" class="dark"></td>
                                    <td id="f7" class="light"></td>
                                    <td id="g7" class="dark"></td>
                                    <td id="h7" class="light"></td>
                                </tr>
                                <tr>
                                    <th>6</th>
                                    <td id="a6" class="light"></td>
                                    <td id="b6" class="dark"></td>
                                    <td id="c6" class="light"></td>
                                    <td id="d6" class="dark"></td>
                                    <td id="e6" class="light"></td>
                                    <td id="f6" class="dark"></td>
                                    <td id="g6" class="light"></td>
                                    <td id="h6" class="dark"></td>
                                </tr>
                                <tr>
                                    <th>5</th>
                                    <td id="a5" class="dark"></td>
                                    <td id="b5" class="light"></td>
                                    <td id="c5" class="dark"></td>
                                    <td id="d5" class="light"></td>
                                    <td id="e5" class="dark"></td>
                                    <td id="f5" class="light"></td>
                                    <td id="g5" class="dark"></td>
                                    <td id="h5" class="light"></td>
                                </tr>
                                <tr>
                                    <th>4</th>
                                    <td id="a4" class="light"></td>
                                    <td id="b4" class="dark"></td>
                                    <td id="c4" class="light"></td>
                                    <td id="d4" class="dark"></td>
                                    <td id="e4" class="light"></td>
                                    <td id="f4" class="dark"></td>
                                    <td id="g4" class="light"></td>
                                    <td id="h4" class="dark"></td>
                                </tr>
                                <tr>
                                    <th>3</th>
                                    <td id="a3" class="dark"></td>
                                    <td id="b3" class="light"></td>
                                    <td id="c3" class="dark"></td>
                                    <td id="d3" class="light"></td>
                                    <td id="e3" class="dark"></td>
                                    <td id="f3" class="light"></td>
                                    <td id="g3" class="dark"></td>
                                    <td id="h3" class="light"></td>
                                </tr>
                                <tr>
                                    <th>2</th>
                                    <td id="a2" class="light"></td>
                                    <td id="b2" class="dark"></td>
                                    <td id="c2" class="light"></td>
                                    <td id="d2" class="dark"></td>
                                    <td id="e2" class="light"></td>
                                    <td id="f2" class="dark"></td>
                                    <td id="g2" class="light"></td>
                                    <td id="h2" class="dark"></td>
                                </tr>
                                <tr>
                                    <th>1</th>
                                    <td id="a1" class="dark"></td>
                                    <td id="b1" class="light"></td>
                                    <td id="c1" class="dark"></td>
                                    <td id="d1" class="light"></td>
                                    <td id="e1" class="dark"></td>
                                    <td id="f1" class="light"></td>
                                    <td id="g1" class="dark"></td>
                                    <td id="h1" class="light"></td>
                                </tr>
                                <tr>
                                    <th></th>
                                    <th>a</th>
                                    <th>b</th>
                                    <th>c</th>
                                    <th>d</th>
                                    <th>e</th>
                                    <th>f</th>
                                    <th>g</th>
                                    <th>h</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-sm">
                <div class="card" id="allgames">
                    <div class="card-header">
                        Games
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">The following Games are happening</h5>
                        <table class="table" id="myTable">
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Wite</th>
                                    <th scope="col">Black</th>
                                    <th scope="col"></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>

        //Initial load and all games
        var theRequest = new XMLHttpRequest();
        var lastgame = sessionStorage.getItem("game");
        var url = "http://localhost:5000/game/" + lastgame;
        if (lastgame != null) {
            theRequest.open('GET', url);
            theRequest.onload = function () {
                var resData = JSON.parse(theRequest.responseText);
                if (resData.error) {
                    sessionStorage.removeItem("game");
                    alert("Start a nuew Game");
                } else {
                    Object.keys(resData.board).forEach(function (keyn) {
                        value = resData.board[keyn];
                        Object.keys(value).forEach(function (keyl) {
                            piece = value[keyl];
                            if (piece != 'None') {
                                document.getElementById(keyl + "" + keyn).innerHTML = `<img src="/static/img/${piece}.png">`;
                            }
                        });
                    });

                    var nextP = document.getElementById("nextp");
                    var p1 = document.getElementById("rp1");
                    var p2 = document.getElementById("rp2");
                    var op1 = document.getElementById("op1");
                    var op2 = document.getElementById("op2");
                    nextP.innerHTML = `<th>Next To Play: ${resData.next_move}</th>`;
                    p1.innerHTML = `<th>White Pieces: ${resData.players.white}</th>`;
                    p2.innerHTML = `<th>White Pieces: ${resData.players.black}</th>`;
                    op1.innerHTML = `<option>${resData.players.white}</option>`;
                    op2.innerHTML = `<option>${resData.players.black}</opttion>`;
                };
            };
            theRequest.send(null);
        }
        var theRequest2 = new XMLHttpRequest();
        theRequest2.open('GET', 'http://localhost:5000/games');
        theRequest2.onload = function () {
            var res = JSON.parse(theRequest2.responseText);
            Object.keys(res).forEach(function (key) {
                value = res[key];
                var myHtmlContent = `
                    <tr>
                        <th scope="row">${value.id}</th>
                        <td>${value.players.white}</td>
                        <td>${value.players.black}</td>
                        <td><button type="submit" class="btn btn-info" onclick="LoadMatch(${value.id})">Go</button></td>
                    </tr>
                    `;
                var tableRef = document.getElementById('myTable').getElementsByTagName('tbody')[0];
                var newRow = tableRef.insertRow(tableRef.rows.length);
                newRow.innerHTML = myHtmlContent;
            })
        };
        theRequest2.send(null);


        //Start a new game
        var btnstart = document.getElementById("btnstart");
        btnstart.addEventListener('click', function (event) {
            player1 = document.getElementById('p1').value;
            player2 = document.getElementById('p2').value;
            var theRequest = new XMLHttpRequest();
            theRequest.open('POST', 'http://localhost:5000/game');
            theRequest.setRequestHeader("Content-Type", "application/json");
            theRequest.onload = function () {
                var resData = JSON.parse(theRequest.responseText);
                sessionStorage.setItem("game", resData.id);
            };
            theRequest.send(JSON.stringify({ "player1": { "name": player1 }, "player2": { "name": player2 } }));

        });

        //Make a move
        var btnplay = document.getElementById("btnplay");
        btnplay.addEventListener('click', function (event) {
            playername = document.getElementById('whoplay').value;
            initpos = document.getElementById('initpos').value;
            endtpos = document.getElementById('endpos').value;
            var lastgame = sessionStorage.getItem("game");
            var url = "http://localhost:5000/game/" + lastgame;
            var theRequest = new XMLHttpRequest();
            theRequest.open('PUT', url);
            theRequest.setRequestHeader("Content-Type", "application/json");
            theRequest.onload = function () {
                var resData = JSON.parse(theRequest.responseText);
                resData.prop = 'exist';
                if (resData.hasOwnProperty('prop')) {
                    if (resData['prop']) {
                    }
                } else {
                    alert(resData);
                }
            }
            theRequest.send(JSON.stringify({ "player": playername, "position": initpos, "new_position": endtpos }));

        });

        //Load a Game
        function LoadMatch(id) {
            var url = "http://localhost:5000/game/" + id;
            var theRequest = new XMLHttpRequest();
            theRequest.open('GET', url);
            theRequest.onload = function () {
                var resData = JSON.parse(theRequest.responseText);
                Object.keys(resData.board).forEach(function (keyn) {
                    value = resData.board[keyn];
                    Object.keys(value).forEach(function (keyl) {
                        piece = value[keyl];
                        if (piece != 'None') {
                            document.getElementById(keyl + "" + keyn).innerHTML = `<img src="/static/img/${piece}.png">`;
                        }
                    });
                });
                sessionStorage.setItem("game", resData.id);
                var nextP = document.getElementById("nextp");
                var p1 = document.getElementById("rp1");
                var p2 = document.getElementById("rp2");
                var op1 = document.getElementById("op1");
                var op2 = document.getElementById("op2");
                nextP.innerHTML = `<th>Next To Play: ${resData.next_move}</th>`;
                p1.innerHTML = `<th>White Pieces: ${resData.players.white}</th>`;
                p2.innerHTML = `<th>White Pieces: ${resData.players.black}</th>`;
                op1.innerHTML = `<option>${resData.players.white}</option>`;
                op2.innerHTML = `<option>${resData.players.black}</opttion>`;
                location.reload()
            }
            theRequest.send(null);
        }

        //Delete Game
        var btnreset = document.getElementById("btnreset");
        btnreset.addEventListener('click', function (event) {
            var lastgame = sessionStorage.getItem("game");
            var url = "http://localhost:5000/game/" + lastgame;
            var theRequest = new XMLHttpRequest();
            theRequest.open('DELETE', url, true);
            theRequest.onload = function () {
                var resData = JSON.parse(theRequest.responseText);
                console.log(resData)
            }
            theRequest.send(null);
            sessionStorage.removeItem("game");
        });

        //Delete all Games
        var btnClean = document.getElementById("btnClean");
        btnClean.addEventListener('click', function (event) {
            var theRequest = new XMLHttpRequest();
            theRequest.open('DELETE', 'http://localhost:5000/games', true);
            theRequest.send(null);
            sessionStorage.removeItem("game");
        });


    </script>
</body>

</html>